package messages

import (
	"testing"

	"github.com/stretchr/testify/suite"

	"github.com/ut-proj/midiserver/pkg/erl"
	"github.com/ut-proj/midiserver/pkg/erl/packets"
	"github.com/ut-proj/midiserver/pkg/types"
)

const (
	Bb     uint8 = 34
	Volume uint8 = 40
)

type MidiMessageTestSuite struct {
	suite.Suite
	batch  interface{}
	device interface{}
	noteOn interface{}
}

func (suite *MidiMessageTestSuite) SetupTest() {
	batchBytes := []byte{0x38, 0x33, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x34, 0x36, 0x44, 0x36, 0x39, 0x36, 0x34, 0x36, 0x39, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x35, 0x36, 0x32, 0x36, 0x31, 0x37, 0x34, 0x36, 0x33, 0x36, 0x38, 0x36, 0x43, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x32, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x32, 0x36, 0x39, 0x36, 0x34, 0x36, 0x44, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x30, 0x33, 0x30, 0x39, 0x36, 0x39, 0x35, 0x37, 0x39, 0x43, 0x41, 0x35, 0x33, 0x34, 0x42, 0x41, 0x30, 0x42, 0x34, 0x41, 0x46, 0x41, 0x43, 0x46, 0x43, 0x45, 0x44, 0x37, 0x30, 0x39, 0x38, 0x36, 0x34, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x38, 0x36, 0x44, 0x36, 0x35, 0x37, 0x33, 0x37, 0x33, 0x36, 0x31, 0x36, 0x37, 0x36, 0x35, 0x37, 0x33, 0x36, 0x43, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x34, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x36, 0x36, 0x34, 0x36, 0x35, 0x37, 0x36, 0x36, 0x39, 0x36, 0x33, 0x36, 0x35, 0x36, 0x31, 0x30, 0x30, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x37, 0x36, 0x33, 0x36, 0x38, 0x36, 0x31, 0x36, 0x45, 0x36, 0x45, 0x36, 0x35, 0x36, 0x43, 0x36, 0x31, 0x30, 0x30, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x37, 0x36, 0x45, 0x36, 0x46, 0x37, 0x34, 0x36, 0x35, 0x35, 0x46, 0x36, 0x46, 0x36, 0x45, 0x36, 0x43, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x32, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x35, 0x37, 0x30, 0x36, 0x39, 0x37, 0x34, 0x36, 0x33, 0x36, 0x38, 0x36, 0x31, 0x32, 0x32, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x38, 0x37, 0x36, 0x36, 0x35, 0x36, 0x43, 0x36, 0x46, 0x36, 0x33, 0x36, 0x39, 0x37, 0x34, 0x37, 0x39, 0x36, 0x31, 0x32, 0x38, 0x36, 0x41, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x38, 0x36, 0x45, 0x36, 0x46, 0x37, 0x34, 0x36, 0x35, 0x35, 0x46, 0x36, 0x46, 0x36, 0x36, 0x36, 0x36, 0x36, 0x31, 0x32, 0x32, 0x36, 0x41, 0x36, 0x41, 0xa}
	deviceBytes := []byte{0x38, 0x33, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x34, 0x36, 0x44, 0x36, 0x39, 0x36, 0x34, 0x36, 0x39, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x35, 0x36, 0x32, 0x36, 0x31, 0x37, 0x34, 0x36, 0x33, 0x36, 0x38, 0x36, 0x43, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x32, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x32, 0x36, 0x39, 0x36, 0x34, 0x36, 0x44, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x30, 0x31, 0x31, 0x46, 0x46, 0x31, 0x33, 0x35, 0x43, 0x37, 0x38, 0x44, 0x35, 0x34, 0x31, 0x35, 0x43, 0x38, 0x38, 0x31, 0x38, 0x43, 0x44, 0x45, 0x37, 0x32, 0x32, 0x35, 0x32, 0x46, 0x46, 0x30, 0x32, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x38, 0x36, 0x44, 0x36, 0x35, 0x37, 0x33, 0x37, 0x33, 0x36, 0x31, 0x36, 0x37, 0x36, 0x35, 0x37, 0x33, 0x36, 0x43, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x36, 0x36, 0x34, 0x36, 0x35, 0x37, 0x36, 0x36, 0x39, 0x36, 0x33, 0x36, 0x35, 0x36, 0x31, 0x30, 0x30, 0x36, 0x41, 0x36, 0x41, 0xa}
	noteOnBytes := []byte{0x38, 0x33, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x34, 0x36, 0x44, 0x36, 0x39, 0x36, 0x34, 0x36, 0x39, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x35, 0x36, 0x32, 0x36, 0x31, 0x37, 0x34, 0x36, 0x33, 0x36, 0x38, 0x36, 0x43, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x32, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x32, 0x36, 0x39, 0x36, 0x34, 0x36, 0x44, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x30, 0x44, 0x45, 0x39, 0x35, 0x30, 0x37, 0x37, 0x39, 0x45, 0x36, 0x30, 0x41, 0x34, 0x33, 0x39, 0x41, 0x42, 0x43, 0x38, 0x33, 0x33, 0x32, 0x37, 0x41, 0x44, 0x46, 0x37, 0x30, 0x44, 0x39, 0x36, 0x31, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x38, 0x36, 0x44, 0x36, 0x35, 0x37, 0x33, 0x37, 0x33, 0x36, 0x31, 0x36, 0x37, 0x36, 0x35, 0x37, 0x33, 0x36, 0x43, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x37, 0x36, 0x45, 0x36, 0x46, 0x37, 0x34, 0x36, 0x35, 0x35, 0x46, 0x36, 0x46, 0x36, 0x45, 0x36, 0x43, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x32, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x35, 0x37, 0x30, 0x36, 0x39, 0x37, 0x34, 0x36, 0x33, 0x36, 0x38, 0x36, 0x31, 0x32, 0x32, 0x36, 0x38, 0x30, 0x32, 0x36, 0x34, 0x30, 0x30, 0x30, 0x38, 0x37, 0x36, 0x36, 0x35, 0x36, 0x43, 0x36, 0x46, 0x36, 0x33, 0x36, 0x39, 0x37, 0x34, 0x37, 0x39, 0x36, 0x31, 0x32, 0x38, 0x36, 0x41, 0x36, 0x41, 0x36, 0x41, 0xa}

	opts := &erl.Opts{IsHexEncoded: true}
	bPkt, err := packets.NewPacket(batchBytes, opts)
	suite.Require().NoError(err)
	suite.batch, err = bPkt.Term()
	suite.Require().NoError(err)
	dPkt, err := packets.NewPacket(deviceBytes, opts)
	suite.Require().NoError(err)
	suite.device, err = dPkt.Term()
	suite.Require().NoError(err)
	nPkt, err := packets.NewPacket(noteOnBytes, opts)
	suite.Require().NoError(err)
	suite.noteOn, err = nPkt.Term()
	suite.Require().NoError(err)
}

func (suite *MidiMessageTestSuite) TestConvertDevice() {
	converted, err := Convert(suite.device)
	calls := converted.Calls()
	suite.Require().Equal(1, len(calls))
	suite.NoError(err)
	suite.Equal("11ff135c-78d5-415c-8818-cde72252ff02", converted.Id())
	suite.Equal(types.MidiDeviceType(), calls[0].Op)
	suite.Equal(uint8(0), calls[0].Args.Device)
}

func (suite *MidiMessageTestSuite) TestConvertNoteOn() {
	converted, err := Convert(suite.noteOn)
	suite.NoError(err)
	calls := converted.Calls()
	suite.Require().Equal(1, len(calls))
	suite.Equal("de950779-e60a-439a-bc83-327adf70d961", converted.Id())
	suite.Equal(types.MidiNoteOnType(), calls[0].Op)
	suite.Equal(Bb, calls[0].Args.NoteOn.Pitch)
	suite.Equal(Volume, calls[0].Args.NoteOn.Velocity)
}

func (suite *MidiMessageTestSuite) TestConvertBatch() {
	converted, err := Convert(suite.batch)
	calls := converted.Calls()
	suite.Require().Equal(4, len(calls))
	suite.NoError(err)
	suite.Equal("30969579-ca53-4ba0-b4af-acfced709864", converted.Id())
	suite.Require().Equal(4, len(calls))
	suite.Equal(1, calls[0].Id)
	suite.Equal(types.MidiDeviceType(), calls[0].Op)
	suite.Equal(uint8(0), calls[0].Args.Device)
	suite.Equal(2, calls[1].Id)
	suite.Equal(types.MidiChannelType(), calls[1].Op)
	suite.Equal(uint8(0), calls[1].Args.Channel)
	suite.Equal(3, calls[2].Id)
	suite.Equal(types.MidiNoteOnType(), calls[2].Op)
	suite.Equal(Bb, calls[2].Args.NoteOn.Pitch)
	suite.Equal(Volume, calls[2].Args.NoteOn.Velocity)
	suite.Equal(4, calls[3].Id)
	suite.Equal(types.MidiNoteOffType(), calls[3].Op)
	suite.Equal(Bb, calls[3].Args.NoteOff)
}

// In order for 'go test' to run this suite, we need to create
// a normal test function and pass our suite to suite.Run
func TestMidiMessageTestSuite(t *testing.T) {
	suite.Run(t, new(MidiMessageTestSuite))
}
